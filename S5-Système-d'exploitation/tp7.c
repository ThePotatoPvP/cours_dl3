#include <sys/stat.h>
#include <sys/wait.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>
#include <stdio.h>
#include <string.h>

int my_cd(int argc, char* argv[]){
    if (argc < 3){
        perror("NotImplemented");
        return 1;
    }
    char* fic1 = argv[1];
    char* fic2 = argv[2];

    int in = open(fic1, O_RDONLY);
    int out = open(fic2, O_WRONLY | O_CREAT | O_TRUNC, S_IRWXU);

    if (dup2(in, STDIN_FILENO)  ==  -1 || dup2(out, STDOUT_FILENO) == -1){
        perror("dup");
    }

    close(in); close(out);
    if(fork()){wait(NULL); return 0;}
    else{execlp("cat", "cat", NULL);exit(0);}
}

int epinards(){
    write(STDOUT_FILENO, "Mange tes épinards!\n", strlen("Mange tes épinards!\n"));
    srandom(getpid());
    if (fork()){
        wait(NULL);
        write(STDOUT_FILENO, "C'est bien, Popeye! Tu seras fort comme papa.\n", strlen("C'est bien, Popeye! Tu seras fort comme papa.\n"));
        return 0;
    }
    while (random() % 2){
        write(STDOUT_FILENO, "Non!\n", 5);
    }
    write(STDOUT_FILENO, "Oui pôpa...\n", strlen("Oui pôpa...\n"));
    exit(0);
}

char* utos(unsigned int n){
    int decimals = (n == 0);
    for(int m=n; m > 0; m /= 10){decimals++;}
    // unsigned int to string
    char* res = malloc(sizeof(char)*(decimals+1));
    if (res == NULL){exit(1);}

    int i = decimals;
    for(; n > 0 || i > 0; n /= 10){
        res[--i] = (char)((n % 10)+48);
    }
    res[decimals] = '\0';
    return res;
}


int dynastie(){
    int k = 18;
    for (;k > 0; k--){
        if (fork() == 0){
            write(STDOUT_FILENO, "Louis ", strlen("Louis "));
            write(STDOUT_FILENO, utos(19-k), strlen(utos(19-k)));
            if (k == 9){write(STDOUT_FILENO, "(dit le Hutin)", strlen("(dit le Hutin)"));}
            write(STDOUT_FILENO, "\n", 1);
        } else {
            wait(NULL);
            exit(0);
        }
    }
    write(STDOUT_FILENO, "et puis plus personne plus rien…\n", strlen("et puis plus personne plus rien…\n"));
    write(STDOUT_FILENO, "Qu'est-ce que c'est que ces gens-là\n", strlen("Qu'est-ce que c'est que ces gens-là\n"));
    write(STDOUT_FILENO, "qui ne sont pas foutus\n", strlen("qui ne sont pas foutus\n"));
    write(STDOUT_FILENO, "de compter jusqu'à vingt ?\n", strlen("de compter jusqu'à vingt ?\n"));
    write(STDOUT_FILENO, "\nJacques Prévert\n", strlen("\nJacques Prévert\n"));
    return 0;
}


int atable(){
    pid_t r = fork();
    if (r == 0){
        srandom(getpid());
        sleep(random() % 10);
        write(STDOUT_FILENO, "Oui, voilà c'est bon quoi!\n", strlen("Oui, voilà c'est bon quoi!\n"));
        exit(3);
    }

    int status;
    for(;;){
        write(STDOUT_FILENO, "À table!\n", strlen("À table!\n"));
        sleep(1);
        if (waitpid(r, &status, WNOHANG) > 0 && WIFEXITED(status)){
            break;
        }
    }
    write(STDOUT_FILENO, "C'est pas trop tôt, tu n'es pas à l'auberge ici!\n", strlen("C'est pas trop tôt, tu n'es pas à l'auberge ici!\n"));
    return 0;
}

int devinette(){
    int st;
    int vals[10];
    pid_t pids[10];
    srandom(getpid());
    int value = random() % 255;
    for(int i=0; i<10; i++){
        pids[i] = fork();
        if (!pids[i]){
            exit(random() % 255);
        }
        wait(&st); vals[i] = WEXITSTATUS(st);
        write(STDOUT_FILENO, "Le fils ", strlen("Le fils "));
        write(STDOUT_FILENO, utos((int)pids[i]), strlen(utos((int)pids[i])));
        write(STDOUT_FILENO, " a la valeur ", strlen(" a la valeur "));
        write(STDOUT_FILENO, utos(vals[i]), strlen(utos(vals[i])));
        write(STDOUT_FILENO, "\n", 1);
        for (int j = random() % 20; j>0; j--){random();}
    }
    write(STDOUT_FILENO, "La bonne valeur est :", strlen("La bonne valeur est :"));
    write(STDOUT_FILENO, utos(value), strlen(utos(value)));
    write(STDOUT_FILENO, "\n", 1);
    for (int i=0; i<10; i++){
        if (vals[i] == value){
            write(1, "Victoire du fils ", strlen("Victoire du fils "));
            write(STDOUT_FILENO,utos((int)pids[i]), strlen(utos((int)pids[i])));
            write(STDOUT_FILENO, " !\n", 3);
        }
    }
    return 0;
}

int main(int argc, char* argv[]){
    //return my_cd(argc, argv);
    //return epinards();
    //return dynastie();
    //return atable();
    return devinette();
}